name: Automated DB Backups

on:
  schedule:
    - cron: '* */12 * * *'
  workflow_dispatch:

jobs:
  backup-database:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Copy backup script to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "automated_db_backups/backup.sh"
          target: "/tmp"
          strip_components: 1

      - name: Run backup on server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            # Define script locations
            TEMP_SCRIPT="/tmp/backup.sh"
            PERMANENT_SCRIPT="/usr/local/bin/mongodb-backup.sh"
            
            # Check if script exists in /usr/local/bin/
            if [ -f "${PERMANENT_SCRIPT}" ]; then
              echo "✓ Found existing script at ${PERMANENT_SCRIPT}"
              SCRIPT_TO_RUN="${PERMANENT_SCRIPT}"
            else
              echo "✗ Script not found at ${PERMANENT_SCRIPT}"
              echo "Installing script from repository..."
              
              # Copy from temp to permanent location
              sudo cp "${TEMP_SCRIPT}" "${PERMANENT_SCRIPT}"
              sudo chmod +x "${PERMANENT_SCRIPT}"
              
              echo "✓ Script installed to ${PERMANENT_SCRIPT}"
              SCRIPT_TO_RUN="${PERMANENT_SCRIPT}"
            fi
            
            # Run the backup script
            echo "Running backup script..."
            ${SCRIPT_TO_RUN}
            
            # Check exit code
            if [ $? -eq 0 ]; then
              echo "✓ Backup completed successfully"
            else
              echo "✗ Backup failed"
              exit 1
            fi

      - name: Notify on failure
        if: failure()
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "❌ Backup failed at $(date)" >> /var/log/mongodb-backup-failures.log